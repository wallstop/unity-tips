---
name: Deploy Documentation

"on":
  push:
    branches: [main]
    paths:
      - "docs/**"
      - "mkdocs.yml"
      - ".github/workflows/docs.yml"
      - "README.md"
      - "CONTRIBUTING.md"
      - "CHANGELOG.md"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    name: Build documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-mkdocs-${{ hashFiles('requirements-docs.txt') }}
          restore-keys: |
            pip-mkdocs-

      - name: Install dependencies
        run: pip install -r requirements-docs.txt

      - name: Prepare documentation structure
        run: |
          # Create docs directory structure for MkDocs
          mkdir -p site-docs

          # Copy root documentation files
          cp README.md site-docs/
          cp CONTRIBUTING.md site-docs/
          cp CHANGELOG.md site-docs/

          # Copy all documentation folders
          cp -r docs/* site-docs/

          # Create index.md from README
          cat > site-docs/index.md << 'EOF'
          ---
          title: Unity Tips & Tools
          description: Battle-tested practices and tools to build better Unity games faster
          ---

          # Unity Tips & Tools

          > Battle-tested practices and tools to build better Unity games faster. From beginner to expert.

          Welcome to the Unity Tips & Tools documentation! This site contains comprehensive guides
          for Unity best practices, recommended tools, and architectural patterns.

          ## Quick Navigation

          <div class="grid cards" markdown>

          - :material-rocket-launch: **[Best Practices](best-practices/README.md)**

              ---

              Prevent 80% of Unity bugs with lifecycle methods, null checks, physics patterns, and more.

          - :material-tools: **[Development Tooling](tooling/README.md)**

              ---

              Auto-format code, catch allocations, and streamline your workflow.

          - :material-animation: **[Animation & Polish](animancer/README.md)**

              ---

              Code-driven animation with Animancer, tweens with PrimeTween, and game juice with Feel.

          - :material-speedometer: **[Performance](graphy/README.md)**

              ---

              Monitor FPS/memory, find asset usage, and optimize your builds.

          </div>

          ## Getting Started

          **New to Unity?** Start with [Best Practices](best-practices/README.md) to avoid common pitfalls.

          **Setting up a project?** Check out [Development Tooling](tooling/README.md) for essential automation.

          **Need specific help?** Use the search bar above or browse the sidebar navigation.

          ---

          [:octicons-mark-github-16: View on GitHub](https://github.com/wallstop/unity-tips){ .md-button }
          EOF

      - name: Build documentation
        run: mkdocs build --config-file mkdocs.yml --site-dir _site
        env:
          MKDOCS_DOCS_DIR: site-docs

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    name: Deploy to GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
