---
name: Lint Docs

"on":
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  pre-commit:
    name: Run pre-commit hooks
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write

    steps:
      - name: Check out PR branch
        if:
          github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name ==
          github.repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Check out repository
        if:
          github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name !=
          github.repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check out push ref
        if: github.event_name != 'pull_request'
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Cache pre-commit environments
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-

      - name: Install pre-commit
        run: pip install --upgrade pip pre-commit

      - name: Run pre-commit
        id: run_precommit
        continue-on-error: true
        run: pre-commit run --all-files

      - name: Apply automatic fixes
        id: apply_fixes
        if:
          steps.run_precommit.outcome == 'failure' && github.event_name == 'pull_request' &&
          github.event.pull_request.head.repo.full_name == github.repository
        run: |
          set -eo pipefail
          if git diff --quiet; then
            echo "changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git commit -m "chore: auto-apply pre-commit fixes"
          if git push; then
            echo "changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "::error::Unable to push auto-fixes. Please run pre-commit locally."
            exit 1
          fi

      - name: Trigger fresh validation after auto-fixes
        if: steps.apply_fixes.outputs.changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.pull_request.head.ref
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'pre-commit.yml',
              ref: branch,
            })

      - name: Re-run pre-commit after fixes
        if:
          steps.run_precommit.outcome == 'failure' && github.event_name == 'pull_request' &&
          github.event.pull_request.head.repo.full_name == github.repository
        run: pre-commit run --all-files

      - name: Fail for push checks
        if: steps.run_precommit.outcome == 'failure' && github.event_name != 'pull_request'
        run: |
          echo "::error::Pre-commit checks failed. Please run 'pre-commit run --all-files' locally."
          exit 1

      - name: Fail for forked pull requests
        if:
          steps.run_precommit.outcome == 'failure' && github.event_name == 'pull_request' &&
          github.event.pull_request.head.repo.full_name != github.repository
        run: |
          echo "::error::Pre-commit checks failed and auto-fix cannot push to forked repositories. Please run 'pre-commit run --all-files' locally."
          exit 1
